<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">

        const { useState, useEffect, useRef } = React;

        function App() {
            const [type, setType] = useState("ÊäµÊäó");
            const [customType, setCustomType] = useState("");
            const [value, setValue] = useState("");
            const [unit, setUnit] = useState("kŒ©");
            const [qty, setQty] = useState("");
            const [date, setDate] = useState("");
            const [memo, setMemo] = useState("");
            const [project, setProject] = useState("");

            const [dataList, setDataList] = useState([]);
            const [summary, setSummary] = useState([]);
            const [start, setStart] = useState("");
            const [end, setEnd] = useState("");
            const [filterCategory, setFilterCategory] = useState("„Åô„Åπ„Å¶");
            const [editRow, setEditRow] = useState(null);
            const [isEditing, setIsEditing] = useState(false);

            const [recordFilter, setRecordFilter] = useState("„Åô„Åπ„Å¶");
            const [sortOrder, setSortOrder] = useState("desc");

            const chartRef = useRef(null);

            const unitOptions = {
                "ÊäµÊäó": ["Œ©", "kŒ©", "MŒ©"],
                "ÂèØÂ§âÊäµÊäó": ["kŒ©", "MŒ©"],
                "„Ç≥„É≥„Éá„É≥„Çµ": ["pF", "nF", "ŒºF"],
                "„Éà„É©„É≥„Ç∏„Çπ„Çø": ["-"],
                "„Ç™„Éö„Ç¢„É≥„Éó": ["-"],
                "„Åù„ÅÆ‰ªñ": ["-"]
            };

            useEffect(() => {
                setUnit(unitOptions[type][0]);
            }, [type]);

            useEffect(() => {
                fetchData();
            },[]); // Á©∫„ÅÆ‰æùÂ≠òÈÖçÂàó„ÇíËøΩÂä†„Åó„Å¶ÂàùÂõû„ÅÆ„ÅøÂÆüË°å



            useEffect(() => {
                if (!chartRef.current || summary.length === 0) return;
                const ctx = chartRef.current.getContext("2d");
                if (window.myChart) window.myChart.destroy();

                const filteredSummary = summary.filter(([name]) => {
                    if (filterCategory === "„Åô„Åπ„Å¶") return true;
                    return name.startsWith(filterCategory);
                });

                const labels = filteredSummary.map(([part]) => part);
                const data = filteredSummary.map(([, count]) => count);

                window.myChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "‰ΩøÁî®Êï∞",
                            data: data,
                            backgroundColor: "rgba(54, 162, 235, 0.6)"
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: "ÈÉ®ÂìÅ„Åî„Å®„ÅÆ‰ΩøÁî®Êï∞Ôºà„Éï„Ç£„É´„Çø„ÉºÂæåÔºâ" },
                            legend: { display: false }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }, [summary, filterCategory]);

            const fetchData = () => {
              google.script.run
                .withSuccessHandler(data => {
                  console.log("ÂèñÂæó„Åó„Åü„Éá„Éº„Çø:", data);
                  setDataList(Array.isArray(data) && data.length > 0 ? data : []);
                })
                .withFailureHandler(error => {
                  console.error("„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:", error);
                  alert("„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error);
                  setDataList([]);
                })
                .getData();
            };

            const resetForm = () => {
                setValue("");
                setQty("");
                setDate("");
                setMemo("");
                setCustomType("");
                setEditRow(null);
                setIsEditing(false);
            };

            const handleSubmit = () => {
                const partName = type === "„Åù„ÅÆ‰ªñ" ? customType : type;
                const finalPartName = ["„Éà„É©„É≥„Ç∏„Çπ„Çø", "„Ç™„Éö„Ç¢„É≥„Éó"].includes(type)
                    ? `${partName} (${customType})`
                    : `${partName} (${value}${unit})`;

                if (isEditing) {
                    google.script.run.withSuccessHandler(() => {
                        alert("Êõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ");
                        fetchData();
                        resetForm();
                    }).updateRow(editRow, finalPartName, qty, date, memo, project);
                } else {
                    google.script.run.withSuccessHandler(() => {
                        alert("Ë®òÈå≤„Åó„Åæ„Åó„ÅüÔºÅ");
                        fetchData();
                        resetForm();
                    }).submitData(finalPartName, qty, date, memo, project);
                }
            };

            const handleSummary = () => {
                if (!start || !end) return;
                google.script.run.withSuccessHandler(setSummary).getDataInRange(start, end);
            };



            return (
                <div style={{ fontFamily: "sans-serif", padding: "1rem", maxWidth: "800px", margin: "auto" }}>
                    <h2>üìã ÈÉ®ÂìÅ‰ΩøÁî®Ë®òÈå≤„Éï„Ç©„Éº„É†</h2>

                    <div>
                        <label>„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç:
                            <input type="text" value={project} onChange={(e) => setProject(e.target.value)} />
                        </label>
                    </div>

                    <div>
                        <label>ÈÉ®ÂìÅ„Ç´„ÉÜ„Ç¥„É™:
                            <select value={type} onChange={(e) => { setType(e.target.value); setCustomType(""); }}>
                                <option>ÊäµÊäó</option>
                                <option>ÂèØÂ§âÊäµÊäó</option>
                                <option>„Ç≥„É≥„Éá„É≥„Çµ</option>
                                <option>„Éà„É©„É≥„Ç∏„Çπ„Çø</option>
                                <option>„Ç™„Éö„Ç¢„É≥„Éó</option>
                                <option>„Åù„ÅÆ‰ªñ</option>
                            </select>
                        </label>
                        {["„Éà„É©„É≥„Ç∏„Çπ„Çø", "„Ç™„Éö„Ç¢„É≥„Éó", "„Åù„ÅÆ‰ªñ"].includes(type) && (
                            <input
                                type="text"
                                placeholder={type === "„Åù„ÅÆ‰ªñ" ? "ÈÉ®ÂìÅÂêç„ÇíÂÖ•Âäõ" : "ÂìÅÁï™„ÇíÂÖ•Âäõ"}
                                value={customType}
                                onChange={(e) => setCustomType(e.target.value)}
                            />
                        )}
                    </div>

                    {!["„Éà„É©„É≥„Ç∏„Çπ„Çø", "„Ç™„Éö„Ç¢„É≥„Éó", "„Åù„ÅÆ‰ªñ"].includes(type) && (
                        <React.Fragment>
                            <div>
                                <label>ÂÄ§:
                                    <input type="text" value={value} onChange={(e) => setValue(e.target.value)} />
                                </label>
                            </div>
                            <div>
                                <label>Âçò‰Ωç:
                                    <select value={unit} onChange={(e) => setUnit(e.target.value)}>
                                        {unitOptions[type].map((u, i) => <option key={i}>{u}</option>)}
                                    </select>
                                </label>
                            </div>
                        </React.Fragment>
                    )}

                    <div>
                        <label>‰ΩøÁî®Êï∞:
                            <input type="number" value={qty} onChange={(e) => setQty(e.target.value)} />
                        </label>
                    </div>

                    <div>
                        <label>Êó•‰ªò:
                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} />
                        </label>
                    </div>

                    <div>
                        <label>„É°„É¢:
                            <input type="text" value={memo} onChange={(e) => setMemo(e.target.value)} />
                        </label>
                    </div>

                    <button onClick={handleSubmit}>{isEditing ? "Êõ¥Êñ∞" : "ÈÄÅ‰ø°"}</button>

                    <h3>üìÖ ÊúüÈñìÂà•Áµ±Ë®à</h3>
                    <div>
                        ÈñãÂßãÊó•: <input type="date" value={start} onChange={(e) => setStart(e.target.value)} />
                        ÁµÇ‰∫ÜÊó•: <input type="date" value={end} onChange={(e) => setEnd(e.target.value)} />
                        <button onClick={handleSummary}>ÈõÜË®à„Åô„Çã</button>
                    </div>

                    {summary.length > 0 && (
                        <React.Fragment>
                            <div>
                                <label>„Ç´„ÉÜ„Ç¥„É™„ÅßÁµû„ÇäËæº„Åø: </label>
                                <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)}>
                                    <option value="„Åô„Åπ„Å¶">„Åô„Åπ„Å¶</option>
                                    <option value="ÊäµÊäó">ÊäµÊäó</option>
                                    <option value="ÂèØÂ§âÊäµÊäó">ÂèØÂ§âÊäµÊäó</option>
                                    <option value="„Ç≥„É≥„Éá„É≥„Çµ">„Ç≥„É≥„Éá„É≥„Çµ</option>
                                    <option value="„Éà„É©„É≥„Ç∏„Çπ„Çø">„Éà„É©„É≥„Ç∏„Çπ„Çø</option>
                                    <option value="„Ç™„Éö„Ç¢„É≥„Éó">„Ç™„Éö„Ç¢„É≥„Éó</option>
                                    <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                                </select>
                            </div>

                            <canvas ref={chartRef} height="300"></canvas>

                            <table border="1" cellPadding="4" style={{ marginTop: "1rem" }}>
                                <thead>
                                    <tr><th>ÈÉ®ÂìÅÂêç</th><th>ÂêàË®à‰ΩøÁî®Êï∞</th></tr>
                                </thead>
                                <tbody>
                                    {summary
                                        .filter(([name]) => filterCategory === "„Åô„Åπ„Å¶" || name.startsWith(filterCategory))
                                        .map(([part, count], idx) => (
                                            <tr key={idx}><td>{part}</td><td>{count}</td></tr>
                                        ))}
                                </tbody>
                            </table>
                        </React.Fragment>
                    )}


                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));

    </script>
</body>

</html>